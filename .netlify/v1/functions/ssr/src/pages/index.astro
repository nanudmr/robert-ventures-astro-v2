---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { Image } from 'astro:assets';
import steve from '../images/testimonials/steve-lloyd.png';
---

<!doctype html>
<html lang="en">
<head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
        main {
            padding: 1.5rem;
            max-width: 366px;
            margin: 0 auto;
        }

        h1 {
            color: #000;
            text-align: center;
            font-family: "Satoshi", sans-serif;
            font-size: 1.4375rem;
            font-weight: 700;
            line-height: 130%;
            margin-bottom: 1.5rem;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        form input {
            padding: 1rem 0.75rem;
            font-size: 1rem;
            font-family: Inter, sans-serif;
            border-radius: 0.75rem;
            border: 1px solid #afb5bc;
        }

        .group {
            display: flex;
            gap: 0.75rem;
        }

        .group input {
            flex: 1;
            min-width: 0;
        }

        button {
            background-color: #5028ff;
            color: #fff;
            padding: 15px;
            font-family: Inter, sans-serif;
            font-size: 1.125rem;
            font-weight: 500;
            border-radius: 0.75rem;
            border: 1px solid #5028ff;
            margin-top: 0.75rem;
            cursor: pointer;
        }

        .signup-error {
            color: red;
            text-align: center;
            display: none;
            font-size: 0.875rem;
        }

        .disclaimer {
            margin-top: 0.75rem;
            font-family: Inter, sans-serif;
            font-size: 14px;
            text-align: center;
            margin-bottom: 3rem;
        }

        a {
            color: #505050;
            text-decoration: underline;
            font-weight: 500;
        }

        .testimonial-photos {
            display: flex;
            justify-content: center;
            margin-bottom: 0.75rem;
        }

        .testimonial-photos img {
            max-width: 80px;
        }

        .testimonial {
            text-align: center;
            font-family: "Inter", sans-serif;
            font-size: 1rem;
            color:#505050;
            margin-bottom: 0.75rem;
        }

        .testimonial-name {
            text-align: center;
            font-family: "Inter", sans-serif;
            font-size: 1.125rem;
            line-height: 1.6;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <Header />

    <main>
        <h1>Open your account in under 2 minutes</h1>

        <form id="signup-form">
            <div class="group">
                <input type="text" name="first_name" placeholder="First Name" required />
                <input type="text" name="last_name" placeholder="Last Name" required />
            </div>
            <input type="email" name="email" placeholder="Email" required />
            <input type="password" name="password" placeholder="Password" required />
            <p class="signup-error"></p>

            <button type="submit">Sign Up</button>
        </form>

        <p class="disclaimer">
            By continuing, you agree to our 
            <a href="https://robertventures.com/privacy-policy">Privacy Policy</a> and
            <a href="https://robertventures.com/terms-of-use">Terms of Use</a>.
        </p>

        <div class="testimonials">
            <div class="testimonial-photos">
                <Image src={steve} alt="A description of my image." />
            </div>
            <p class="testimonial">“I've known Joe for over a decade now and he has been more than just a friend but has been instrumental in our holding company to make accountable double-digit returns and has been a blessing. Always could count on him for the payments.”</p>
            <p class="testimonial-name">Steve Lloyd</p>
        </div>
    </main>

    <Footer />

    <script is:inline>
        document.addEventListener("DOMContentLoaded", async () => {
            const form = document.getElementById("signup-form");
            const errorElement = document.querySelector(".signup-error");

            // Fetch client's IP address
            let ip_address = null;
            try {
                const ipResponse = await fetch("https://api64.ipify.org?format=json");
                if (ipResponse.ok) {
                    const ipData = await ipResponse.json();
                    ip_address = ipData.ip;
                }
            } catch (err) {
                console.warn("⚠ Error fetching IP address.");
            }

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                errorElement.style.display = "none";

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.ip_address = ip_address; // Include IP address in the signup data

                try {
                    // Send form data to backend
                    const response = await fetch("/api/signup", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        const errorMessage = result.details ? (typeof result.details === 'string' ? result.details : JSON.stringify(result.details)) : result.error;
                        throw new Error(errorMessage || "Signup failed. Please try again.");
                    }

                    // Store necessary information in local storage
                    if (result.session) {
                        localStorage.setItem("supabase_token", result.session.access_token);
                    }

                    if (result.ghl_id) {
                        localStorage.setItem("ghl_contact_id", result.ghl_id);
                    }

                    // Redirect on success
                    console.log("✅ Signup successful! Redirecting...");
                    window.location.href = "/step-2";
                } catch (error) {
                    console.error("❌ Error during signup:", error);
                    errorElement.textContent = error.message;
                    errorElement.style.display = "block";
                }
            });
        });
    </script>
</body>
</html>
