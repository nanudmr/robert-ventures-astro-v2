---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    </head>
    <body>
        <Header />

        <main>
            <h1>Sign up page step 3</h1>

            <form id="signup-form-step-3" action="/api/signup-step-3" method="post">

            <input type="tel" id="phone" name="phone_number" placeholder="1234567890" required>

            <button type="submit">continue</button>

            </form>
        </main>

        <Footer />
    </body>
</html>

<script is:inline>
    document
        .getElementById("signup-form-step-3")
        .addEventListener("submit", async (e) => {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            // ✅ Retrieve GoHighLevel Contact ID from localStorage
            const ghlContactId = localStorage.getItem("ghl_contact_id");

            if (!ghlContactId) {
                console.error("GoHighLevel Contact ID not found in localStorage!");
                alert("Error: Unable to find your contact ID. Please restart signup.");
                return;
            }

            formData.append("ghl_contact_id", ghlContactId);

            // ✅ Validate phone number (US format)
            const phoneInput = document.getElementById("phone").value.trim();
            const phoneRegex = /^\+?1?\d{10}$/; // Matches US numbers (with or without country code)

            if (!phoneRegex.test(phoneInput)) {
                alert("Please enter a valid US phone number (10 digits).");
                return;
            }

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("Step 3 Completed:", result);
                    alert("Step 3 completed successfully!");
                    window.location.href = "/signup-step-4"; // Proceed to Step 4
                } else {
                    const error = await response.json();
                    alert(`Signup failed: ${error.error}`);
                }
            } catch (err) {
                console.error("Error during signup:", err);
                alert("An unexpected error occurred.");
            }
        });
</script>

